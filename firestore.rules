rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }

    function myUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function myRoles() {
      return signedIn()
        ? (
            myUserDoc().data.roles != null
              ? myUserDoc().data.roles
              : (
                  myUserDoc().data.role != null
                    ? [myUserDoc().data.role]
                    : (
                        myUserDoc().data.isDualRole == true
                          ? ['SUPERVISOR', 'HR_ADMIN']
                          : []
                      )
                )
          )
        : [];
    }

    function hasRole(role) {
      return signedIn() && myRoles().hasAny([role]);
    }

    function isHrAdmin() {
      return hasRole('HR_ADMIN');
    }

    function isSupervisor() {
      return hasRole('SUPERVISOR');
    }

    function isSelf(uid) {
      return signedIn() && request.auth.uid == uid;
    }

    function isAssignedSupervisorOf(uid) {
      return isSupervisor() && get(/databases/$(database)/documents/users/$(uid)).data.supervisorId == request.auth.uid;
    }

    match /users/{uid} {
      allow read, write: if signedIn();
    }

    match /users/{uid}/{subCol}/{docId} {
      allow read, write: if signedIn();
    }

    match /config/{docId} {
      allow read, write: if signedIn();
    }

    match /allowanceClaims/{claimId} {
      allow read, write: if signedIn();
    }

    match /certificateTemplates/{templateId} {
      allow read, write: if signedIn();
    }

    match /certificateRequests/{requestId} {
      allow read, write: if signedIn();
    }

    match /universityEvaluations/{docId} {
      allow read, write: if signedIn();
    }

    match /leaveRequests/{id} {
      allow read, write: if signedIn();
    }

    match /{document=**} {
      allow read, write: if signedIn();
    }
  }
}
