rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }

    function myUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function myUserDocData() {
      return signedIn() && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        ? myUserDoc().data
        : {};
    }

    function myRoles() {
      return signedIn()
        ? (
            myUserDocData().roles is list
              ? myUserDocData().roles
              : (
                  myUserDocData().roles is string
                    ? [myUserDocData().roles]
                    : (
                        myUserDocData().role is string
                          ? [myUserDocData().role]
                          : (
                              myUserDocData().isDualRole == true
                                ? ['SUPERVISOR', 'HR_ADMIN']
                                : []
                            )
                      )
                )
          )
        : [];
    }

    function hasRole(role) {
      return signedIn() && myRoles().hasAny([role]);
    }

    function isHrAdmin() {
      return hasRole('HR_ADMIN');
    }

    function isSupervisor() {
      return hasRole('SUPERVISOR');
    }

    function isSelf(uid) {
      return signedIn() && request.auth.uid == uid;
    }

    function isAssignedSupervisorOf(uid) {
      return isSupervisor() &&
        exists(/databases/$(database)/documents/users/$(uid)) &&
        get(/databases/$(database)/documents/users/$(uid)).data.supervisorId == request.auth.uid;
    }

    function isMySupervisor(uid) {
      return signedIn() && myUserDocData().supervisorId == uid;
    }

    match /users/{uid} {
      allow read: if signedIn();
      allow write: if isSelf(uid) || isHrAdmin();
    }

    match /users/{uid}/{subcollection}/{docId} {
      allow read, write: if isSelf(uid) || isHrAdmin() || isAssignedSupervisorOf(uid);

      match /{rest=**} {
        allow read, write: if isSelf(uid) || isHrAdmin() || isAssignedSupervisorOf(uid);
      }
    }

    match /CurrentWallet/{internId} {
      allow read: if isHrAdmin() || isSelf(internId) || isAssignedSupervisorOf(internId);
      // Client writes are restricted to HR admin. Cloud Functions use Admin SDK.
      allow create, update, delete: if isHrAdmin();
    }

    match /walletSyncLocks/{internId} {
      allow read: if isHrAdmin() || isSelf(internId) || isAssignedSupervisorOf(internId);
      allow create, update, delete: if false;
    }

    match /config/{docId} {
      allow read: if signedIn();
      allow write: if isHrAdmin();
    }

    match /payPeriods/{monthKey} {
      allow read, write: if isHrAdmin();
    }

    match /policyTrainingContents/{contentId} {
      allow read: if signedIn();
      allow write: if isHrAdmin();

      match /assets/{assetId} {
        allow read: if signedIn();
        allow write: if isHrAdmin();
      }

      match /acknowledgements/{uid} {
        allow read: if isHrAdmin() || isSelf(uid);
        allow write: if isHrAdmin() || isSelf(uid);
      }
    }

    match /allowanceClaims/{claimId} {
      allow read: if isHrAdmin() || (signedIn() && resource.data.internId == request.auth.uid) || (resource.data.internId is string && isAssignedSupervisorOf(resource.data.internId));
      allow create: if isHrAdmin() || (signedIn() && request.resource.data.internId == request.auth.uid);
      allow update, delete: if isHrAdmin() || (signedIn() && resource.data.internId == request.auth.uid) || (resource.data.internId is string && isAssignedSupervisorOf(resource.data.internId));
    }

    match /allowanceWallets/{internId} {
      allow read: if isHrAdmin() || isSelf(internId) || isAssignedSupervisorOf(internId);
      // Client writes are restricted to HR admin. Cloud Functions use Admin SDK.
      allow create, update, delete: if isHrAdmin();

      match /months/{monthKey} {
        allow read: if isHrAdmin() || isSelf(internId) || isAssignedSupervisorOf(internId);
        allow create, update, delete: if isHrAdmin();
      }
    }

    match /certificateTemplates/{templateId} {
      allow read: if signedIn();
      allow write: if isHrAdmin();
    }

    match /certificateRequests/{requestId} {
      allow read: if isHrAdmin() || (signedIn() && (resource.data.internId == request.auth.uid || resource.data.supervisorId == request.auth.uid));
      allow create: if isHrAdmin() || (signedIn() && request.resource.data.internId == request.auth.uid);
      allow update, delete: if isHrAdmin() || (signedIn() && resource.data.supervisorId == request.auth.uid);
    }

    match /universityEvaluations/{docId} {
      allow read: if isHrAdmin() || isSelf(docId) || (signedIn() && (resource.data.internId == request.auth.uid || resource.data.supervisorId == request.auth.uid));
      allow create: if isHrAdmin() || (signedIn() && request.resource.data.internId == request.auth.uid);
      allow update, delete: if isHrAdmin() || (
        signedIn() && (
          resource.data.internId == request.auth.uid ||
          (
            resource.data.supervisorId == request.auth.uid &&
            !(resource.data.appointmentRequest is map && resource.data.appointmentRequest.status == 'CANCELLED')
          )
        )
      );
    }

    match /leaveRequests/{id} {
      allow read: if isHrAdmin() || (
        signedIn() && (
          resource.data.internId == request.auth.uid ||
          resource.data.supervisorId == request.auth.uid ||
          (resource.data.internId is string && isAssignedSupervisorOf(resource.data.internId))
        )
      );
      allow create: if signedIn() && request.resource.data.internId == request.auth.uid;
      allow update, delete: if isHrAdmin() || (signedIn() && resource.data.supervisorId == request.auth.uid);
    }

    match /timeCorrections/{id} {
      allow read: if isHrAdmin() || (
        signedIn() && (
          resource.data.internId == request.auth.uid ||
          resource.data.supervisorId == request.auth.uid ||
          (resource.data.internId is string && isAssignedSupervisorOf(resource.data.internId))
        )
      );

      allow create: if signedIn() && request.resource.data.internId == request.auth.uid;

      allow update, delete: if isHrAdmin() || (
        signedIn() && (
          resource.data.internId == request.auth.uid ||
          request.resource.data.internId == request.auth.uid ||
          resource.data.supervisorId == request.auth.uid ||
          (resource.data.internId is string && isAssignedSupervisorOf(resource.data.internId))
        )
      );
    }

    match /attendanceExcelImports/{importId} {
      allow read: if isHrAdmin() || (
        signedIn() && (
          resource.data.internId == request.auth.uid ||
          (resource.data.internId is string && isAssignedSupervisorOf(resource.data.internId))
        )
      );

      allow create: if signedIn() &&
        request.resource.data.internId == request.auth.uid &&
        request.resource.data.status == 'PENDING' &&
        !(request.resource.data.keys().hasAny([
          'reviewAction',
          'reviewedById',
          'reviewedByName',
          'reviewedByRole',
          'reviewedAt',
          'appliedAt',
          'appliedById',
          'resultSummary',
          'skippedPaidMonths',
          'errors'
        ]));

      allow update, delete: if isHrAdmin() || (
        signedIn() && (resource.data.internId is string && isAssignedSupervisorOf(resource.data.internId))
      );
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
