rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }

    function myUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function myUserDocData() {
      return signedIn() && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        ? myUserDoc().data
        : {};
    }

    function myRoles() {
      return signedIn()
        ? (
            myUserDocData().roles != null
              ? myUserDocData().roles
              : (
                  myUserDocData().role != null
                    ? [myUserDocData().role]
                    : (
                        myUserDocData().isDualRole == true
                          ? ['SUPERVISOR', 'HR_ADMIN']
                          : []
                      )
                )
          )
        : [];
    }

    function hasRole(role) {
      return signedIn() && myRoles().hasAny([role]);
    }

    function isHrAdmin() {
      return hasRole('HR_ADMIN');
    }

    function isSupervisor() {
      return hasRole('SUPERVISOR');
    }

    function isSelf(uid) {
      return signedIn() && request.auth.uid == uid;
    }

    function isAssignedSupervisorOf(uid) {
      return isSupervisor() &&
        exists(/databases/$(database)/documents/users/$(uid)) &&
        get(/databases/$(database)/documents/users/$(uid)).data.supervisorId == request.auth.uid;
    }

    function isMySupervisor(uid) {
      return signedIn() && myUserDocData().supervisorId == uid;
    }

    match /users/{uid} {
      allow read: if signedIn();
      allow write: if isSelf(uid) || isHrAdmin();
    }

    match /users/{uid}/{subcollection}/{docId} {
      allow read, write: if isSelf(uid) || isHrAdmin() || isAssignedSupervisorOf(uid);

      match /{rest=**} {
        allow read, write: if isSelf(uid) || isHrAdmin() || isAssignedSupervisorOf(uid);
      }
    }

    match /config/{docId} {
      allow read: if signedIn();
      allow write: if isHrAdmin();
    }

    match /payPeriods/{monthKey} {
      allow read, write: if isHrAdmin();
    }

    match /policyTrainingContents/{contentId} {
      allow read: if signedIn();
      allow write: if isHrAdmin();

      match /assets/{assetId} {
        allow read: if signedIn();
        allow write: if isHrAdmin();
      }

      match /acknowledgements/{uid} {
        allow read: if isHrAdmin() || isSelf(uid);
        allow write: if isHrAdmin() || isSelf(uid);
      }
    }

    match /allowanceClaims/{claimId} {
      allow read: if isHrAdmin() || (signedIn() && resource.data.internId == request.auth.uid) || (resource.data.internId is string && isAssignedSupervisorOf(resource.data.internId));
      allow create: if isHrAdmin() || (signedIn() && request.resource.data.internId == request.auth.uid);
      allow update, delete: if isHrAdmin() || (signedIn() && resource.data.internId == request.auth.uid) || (resource.data.internId is string && isAssignedSupervisorOf(resource.data.internId));
    }

    match /certificateTemplates/{templateId} {
      allow read: if signedIn();
      allow write: if isHrAdmin();
    }

    match /certificateRequests/{requestId} {
      allow read: if isHrAdmin() || (signedIn() && (resource.data.internId == request.auth.uid || resource.data.supervisorId == request.auth.uid));
      allow create: if isHrAdmin() || (signedIn() && request.resource.data.internId == request.auth.uid);
      allow update, delete: if isHrAdmin() || (signedIn() && resource.data.supervisorId == request.auth.uid);
    }

    match /universityEvaluations/{docId} {
      allow read: if isHrAdmin() || isSelf(docId) || (signedIn() && (resource.data.internId == request.auth.uid || resource.data.supervisorId == request.auth.uid));
      allow create: if isHrAdmin() || (signedIn() && request.resource.data.internId == request.auth.uid);
      allow update, delete: if isHrAdmin() || (
        signedIn() && (
          resource.data.internId == request.auth.uid ||
          (
            resource.data.supervisorId == request.auth.uid &&
            !(resource.data.appointmentRequest is map && resource.data.appointmentRequest.status == 'CANCELLED')
          )
        )
      );
    }

    match /leaveRequests/{id} {
      allow read: if isHrAdmin() || (
        signedIn() && (
          resource.data.internId == request.auth.uid ||
          resource.data.supervisorId == request.auth.uid ||
          (resource.data.internId is string && isAssignedSupervisorOf(resource.data.internId))
        )
      );
      allow create: if signedIn() && request.resource.data.internId == request.auth.uid;
      allow update, delete: if isHrAdmin() || (signedIn() && resource.data.supervisorId == request.auth.uid);
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
